import e from"@babel/runtime/helpers/defineProperty";import r from"@babel/runtime/helpers/classCallCheck";import t from"@babel/runtime/helpers/createClass";import i from"@babel/runtime/regenerator";import o from"@babel/runtime/helpers/asyncToGenerator";import n from"../utils/main.js";import{isNativeDetected as l}from"../utils/mobileDetect.js";import{jsxs as s,jsx as a,Fragment as p}from"react/jsx-runtime";import{createRef as u,PureComponent as d}from"react";import{getS3SignedUrl as c}from"../clients/jsonApi/index.js";import f from"prop-types";import m from"@babel/runtime/helpers/assertThisInitialized";import h from"@babel/runtime/helpers/inherits";import b from"@babel/runtime/helpers/possibleConstructorReturn";import g from"@babel/runtime/helpers/getPrototypeOf";import{withStyles as F}from"@material-ui/core/styles";import v from"@material-ui/core/IconButton";import U from"react-s3-uploader/s3upload";import y from"@material-ui/core/CircularProgress";import S from"@material-ui/icons/PhotoCamera";import P from"./PostPreviewDialog/index.js";import O from"./Icons/AttachIcon.js";function w(e,r){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);r&&(i=i.filter((function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable}))),t.push.apply(t,i)}return t}function D(r){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?w(Object(i),!0).forEach((function(t){e(r,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(i)):w(Object(i)).forEach((function(e){Object.defineProperty(r,e,Object.getOwnPropertyDescriptor(i,e))}))}return r}function j(e){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var t,i=g(e);if(r){var o=g(this).constructor;t=Reflect.construct(i,arguments,o)}else t=i.apply(this,arguments);return b(this,t)}}var C=function(l){h(b,d);var f=j(b);function b(t){var l,s;return r(this,b),l=f.call(this,t),e(m(l),"onFinish",(function(){l.setState({currentUpload:null,uploadingFileToS3:!1,openFileUploadPreviewDialog:l.props.openPreviewDialogOnUpload},(function(){l.props.onFinish&&l.props.onFinish(l.state.s3FileUrl,l.state.s3FileName,l.state.s3FileSize)}))})),e(m(l),"onError",(function(e){l.props.onError&&l.props.onError(e),console.error(e)})),e(m(l),"getSignedUrl",(s=o(i.mark((function e(r,t){var o;return i.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,c(r.name,r.type);case 3:o=e.sent,e.next=10;break;case 6:return e.prev=6,e.t0=e.catch(0),l.setState({uploadingFileToS3:null,currentUpload:null},(function(){l.onError(e.t0.message)})),e.abrupt("return");case 10:l.setState({s3FileUrl:n.getS3FileUrl(o.bucket,o.file_name),s3FileName:o.display_name,s3FileSize:r.size}),t(D(D({},o),{},{signedUrl:o.signed_url}));case 12:case"end":return e.stop()}}),e,null,[[0,6]])}))),function(e,r){return s.apply(this,arguments)})),e(m(l),"preprocess",(function(e,r){r(e)})),e(m(l),"uploadFile",(function(e){if(e.target.files[0]){l.clearUpload();var r=new U({fileElement:l.fileInput.current,getSignedUrl:l.getSignedUrl,preprocess:l.preprocess,onProgress:function(){},onFinishS3Put:l.onFinish,onError:l.onError});l.setState({uploadingFileToS3:!0,currentUpload:{uploader:r}})}})),e(m(l),"handleCloseFileUploadPreviewDialog",(function(){l.setState({openFileUploadPreviewDialog:!1})})),e(m(l),"handleShare",(function(e,r,t){l.setState({openFileUploadPreviewDialog:!1},(function(){l.props.handleShare&&l.props.handleShare(e,r,t)}))})),l.state={currentUpload:null,s3FileUrl:null,s3FileName:null,s3FileSize:null,uploadingFileToS3:!1,openFileUploadPreviewDialog:!1},l.fileInput=u(),l}return t(b,[{key:"clearUpload",value:function(){var e=this.state.currentUpload;e&&e.uploader&&e.uploader.abortUpload()}},{key:"renderUploadButton",value:function(){var e=this.props.isNative?S:O;return s("label",{htmlFor:this.props.inputId,children:[a("input",{ref:this.fileInput,id:this.props.inputId,type:"file",disabled:this.props.disabled,onChange:this.uploadFile,style:{display:"none"}}),a(v,{"data-not-migrated-MuiIconButton":!0,"data-testid":"".concat("fileUpload","_attachFileButton"),"aria-label":"File Upload",disabled:this.props.disabled,component:this.props.disabled?"button":"span",className:this.props.fileUploadIconClassName,disableRipple:this.props.disableRipple,children:a(e,{htmlColor:this.props.disabled?"":this.props.nativeColor})})]})}},{key:"render",value:function(){return s(p,{children:[this.state.uploadingFileToS3?a(y,{"data-testid":"generic_uploadProgress",classes:{root:this.props.classes.progressRoot},size:20}):this.renderUploadButton(),this.state.openFileUploadPreviewDialog&&a(P,{open:this.state.openFileUploadPreviewDialog,fileUrl:this.state.s3FileUrl,fileName:this.state.s3FileName,fileSize:this.state.s3FileSize,handleShare:this.handleShare,handleClose:this.handleCloseFileUploadPreviewDialog,additionalFields:this.props.additionalFields,requiredFields:this.props.requiredFields,message:this.props.message})]})}}]),b}();C.propTypes={nativeColor:f.string,disabled:f.bool,handleShare:f.func,inputId:f.string,openPreviewDialogOnUpload:f.bool,onFinish:f.func,onError:f.func,classes:f.shape({}).isRequired,isNative:f.bool.isRequired,fileUploadIconClassName:f.string,additionalFields:f.arrayOf(f.node),requiredFields:f.arrayOf(f.string),message:f.string,disableRipple:f.bool},C.defaultProps={nativeColor:"black",disabled:!1,fileUploadIconClassName:void 0,handleShare:void 0,additionalFields:[],requiredFields:[],message:void 0,inputId:"icon-button-file",disableRipple:!1,openPreviewDialogOnUpload:!0,onFinish:void 0,onError:void 0,isNative:l};var I=F({progressRoot:{margin:14}})(C);export default I;

import e from"@babel/runtime/helpers/slicedToArray";import n from"@babel/runtime/regenerator";import t from"@babel/runtime/helpers/asyncToGenerator";import r from"@babel/runtime/helpers/toConsumableArray";import{jsx as o,jsxs as s}from"react/jsx-runtime";import{Button as i,Typography as a}from"@material-ui/core";import{useRef as c,useState as m,useEffect as u}from"react";import{getAnnotationComments as p,postAnnotationComment as l}from"../../../../../../clients/jsonApi/index.js";import{string as d,bool as f,number as C,func as h,shape as v}from"prop-types";import{withStyles as b}from"@material-ui/core/styles";import I from"../../../../../LoadingIndicator/LoadingIndicator.js";import y from"../../../../../CommentInput/index.js";import x from"../../../../../CommentLoader.js";import g from"../../../../../Comment/index.js";import k from"./style.css.js";var w=function(d){var f=d.annotationId,C=d.commentInputIsOpen,h=d.commentsCount,v=d.setCommentsCount,b=d.initialCommentsCount,w=d.classes,R=d.assetCompanyId,j=d.currentUser,q=c(),A=m([]),L=e(A,2),M=L[0],N=L[1],T=m(!1),U=e(T,2),_=U[0],O=U[1],V=m(!1),z=e(V,2),D=z[0],G=z[1],P=m(1),B=e(P,2),E=B[0],F=B[1],H=m(3),J=e(H,2),K=J[0],Q=J[1],S=function(e){var n=M.findIndex((function(n){return n.id===e.id})),t=r(M);t.splice(n,1,e),N(t)},W=function(e){N(M.filter((function(n){return n.id!==e}))),v(h-1)};u((function(){function e(){return(e=t(n.mark((function e(){var t;return n.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(f){e.next=2;break}return e.abrupt("return");case 2:return O(!0),e.prev=3,e.next=6,p(f,{page:E,per_page:3,order:"desc"});case 6:t=e.sent,N(t),e.next=13;break;case 10:e.prev=10,e.t0=e.catch(3),console.error(e.t0);case 13:O(!1);case 14:case"end":return e.stop()}}),e,null,[[3,10]])})))).apply(this,arguments)}!function(){e.apply(this,arguments)}()}),[]);var X,Y=(X=t(n.mark((function e(){var t,o,s;return n.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return O(!0),Q((o=(t=3===K)?7:10)+K),e.prev=4,e.next=7,p(f,{page:t?1:E,per_page:o,order:"desc",offset:1===E?M.length:h-b+10});case 7:s=e.sent,N([].concat(r(M),r(s))),t||F(E+1),e.next=15;break;case 12:e.prev=12,e.t0=e.catch(4),console.error(e.t0);case 15:O(!1);case 16:case"end":return e.stop()}}),e,null,[[4,12]])}))),function(){return X.apply(this,arguments)}),Z=M.slice(0,K).reverse(),$=h>K;return _&&!M.length?o(I,{fullscreen:!1}):s("div",{className:k.cAnnotationCommentsList,children:[$&&o(i,{"data-testid":"".concat("annotationComments","_viewMoreComments"),className:w.showMore,onClick:Y,children:o(a,{variant:"caption",color:"primary",children:"View more comments"})}),s("div",{className:k.cAnnotationCommentsListItems,children:[_&&M.length&&o(I,{fullscreen:!1,size:30}),Z.map((function(e){return o(g,{comment:e,handleDeleteCallback:W,patchCommentCallback:S,companyId:R,currentUser:j},e.id)}))]}),D&&o(x,{spaceAround:!0}),C&&o("div",{className:k.cAnnotationCommentsListInput,children:o(y,{inputRef:q,postComment:function(e){return l(f,e)},setIsPosting:G,postCommentCallback:function(e){N([e].concat(r(M))),v(h+1)},onMount:function(){var e=q.current;e&&(e.scrollIntoView({behavior:"smooth",block:"nearest",inline:"start"}),e.focus())},companyId:R,currentUser:j})})]})};w.propTypes={annotationId:d.isRequired,commentInputIsOpen:f.isRequired,commentsCount:C.isRequired,initialCommentsCount:C.isRequired,setCommentsCount:h.isRequired,classes:v().isRequired,assetCompanyId:C.isRequired,currentUser:v({}).isRequired};var R=b({showMore:{textTransform:"none",backgroundColor:"transparent!important",padding:0}})(w);export default R;

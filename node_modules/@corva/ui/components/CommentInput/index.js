import t from"@babel/runtime/helpers/defineProperty";import e from"@babel/runtime/helpers/classCallCheck";import n from"@babel/runtime/helpers/createClass";import{get as o}from"lodash";import i from"@babel/runtime/regenerator";import r from"@babel/runtime/helpers/asyncToGenerator";import a from"@material-ui/core/colors/grey";import s from"../../utils/main.js";import{notifyCommentEdit as l,notifyCommentPost as c}from"../../utils/nativeMessages.js";import{isNativeDetected as m}from"../../utils/mobileDetect.js";import{jsxs as p,jsx as d}from"react/jsx-runtime";import{Paper as u,TextField as h,InputAdornment as f,Tooltip as C,Typography as g,IconButton as b}from"@material-ui/core";import{PureComponent as v}from"react";import{patchFeedItemComment as I}from"../../clients/jsonApi/index.js";import x from"lodash/noop";import y from"prop-types";import E from"classnames";import F from"@babel/runtime/helpers/assertThisInitialized";import S from"@babel/runtime/helpers/inherits";import U from"@babel/runtime/helpers/possibleConstructorReturn";import k from"@babel/runtime/helpers/getPrototypeOf";import{withStyles as N}from"@material-ui/core/styles";import M from"../Avatar/index.js";import{isSuggestionsListOpened as A}from"../UserMention/utils/index.js";import R from"../UserMention/index.js";import j from"../EmojiIconButton.js";import w from"../FailedFileUploading.js";import L from"../FileUploadIconButton.js";import T from"../FilePreview/index.js";import P from"../Icons/SendIcon.js";import D from"./styles.css.js";function B(t){var e=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}();return function(){var n,o=k(t);if(e){var i=k(this).constructor;n=Reflect.construct(o,arguments,i)}else n=o.apply(this,arguments);return U(this,n)}}var z={chatAvatarWrapper:{display:"inline-block",verticalAlign:"top",position:"absolute",left:-18},commentTextFieldContainer:{position:"relative",margin:"0"},commentTextFieldContainerSpaceAround:{position:"relative",margin:"20px 10px"}},_=function(m){S(y,v);var x=B(y);function y(n){var o,a,s;return e(this,y),o=x.call(this,n),t(F(o),"handleSelectEmoji",(function(t){return o.setState((function(e){var n=e.comment;return{comment:"".concat(n).concat(t.native)}}))})),t(F(o),"postComment",(a=r(i.mark((function t(e){var n;return i.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,t.next=3,o.props.postComment(e);case 3:n=t.sent,t.next=9;break;case 6:t.prev=6,t.t0=t.catch(0),console.error(t.t0.message);case 9:return t.abrupt("return",n);case 10:case"end":return t.stop()}}),t,null,[[0,6]])}))),function(t){return a.apply(this,arguments)})),t(F(o),"patchComment",(s=r(i.mark((function t(e){var n,r,a,s;return i.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return n=o.props,r=n.editFeedItemId,a=n.editCommentId,t.prev=1,t.next=4,I(r,a,e);case 4:s=t.sent,t.next=10;break;case 7:t.prev=7,t.t0=t.catch(1),console.error(t.t0.message);case 10:return t.abrupt("return",s);case 11:case"end":return t.stop()}}),t,null,[[1,7]])}))),function(t){return s.apply(this,arguments)})),t(F(o),"clearCommentField",(function(t){o.setState({comment:"",attachmentUrl:null,attachmentName:null,attachmentSize:null},(function(){o.focusOnRef(),t&&"function"==typeof t&&t()}))})),t(F(o),"handleKeyDown",(function(t){var e=t.key;"Escape"===e&&o.props.exitEditMode(),"Enter"===e&&(A()||(t.preventDefault(),o.handleSendComment()))})),t(F(o),"handleAttachmentLoadingError",(function(t){o.setState({attachmentUrl:null,attachmentName:null,attachmentSize:null,attachmentLoadingError:t})})),t(F(o),"handleFileUpload",(function(t,e,n){o.setState({attachmentUrl:t,attachmentName:e,attachmentSize:n,attachmentLoadingError:null})})),t(F(o),"handleNativeFileUpload",(function(){var t=o.state.comment;o.isEditMode?(l(t),o.clearCommentField(o.props.exitEditMode)):(c(t),o.clearCommentField())})),t(F(o),"handleFileDelete",(function(){return o.setState({attachmentUrl:null,attachmentName:null,attachmentSize:null})})),t(F(o),"handleSendComment",r(i.mark((function t(){var e,n,r;return i.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if((e=o.state.comment?o.state.comment.trim():null)||o.state.attachmentUrl){t.next=3;break}return t.abrupt("return");case 3:if(n={comment:{body:e,attachment:{url:o.state.attachmentUrl,size:o.state.attachmentSize}}},!o.isEditMode){t.next=16;break}return o.props.setIsEditting(!0),t.next=8,o.patchComment(n);case 8:return r=t.sent,t.next=11,o.props.patchCommentCallback(r);case 11:o.props.setIsEditting(!1),o.clearCommentField(),o.props.exitEditMode(),t.next=24;break;case 16:return o.props.setIsPosting(!0),t.next=19,o.postComment(n);case 19:return r=t.sent,t.next=22,o.props.postCommentCallback(r);case 22:o.props.setIsPosting(!1),o.clearCommentField();case 24:case"end":return t.stop()}}),t)})))),t(F(o),"handleCloseEditClick",(function(){o.setState({comment:""}),o.props.exitEditMode()})),o.state={comment:"",attachmentUrl:null,attachmentName:null,attachmentSize:null,attachmentLoadingError:null},o}return n(y,[{key:"componentDidMount",value:function(){this.isEditMode&&this.setInitialCommentValue()}},{key:"componentDidUpdate",value:function(t){(this.isEditMode&&!t.editFeedItemId||this.props.editCommentId&&this.props.editCommentId!==t.editCommentId)&&this.setInitialCommentValue()}},{key:"setInitialCommentValue",value:function(){var t=this.props.editAttachment?this.props.editAttachment.url:null;this.setState({comment:this.props.editComment,attachmentUrl:t,attachmentName:t?s.getFileNameWithExtensionFromPath(t):null,attachmentSize:this.props.editAttachment?this.props.editAttachment.url:null})}},{key:"focusOnRef",value:function(){this.props.inputRef&&this.props.inputRef.current.focus()}},{key:"render",value:function(){var t=this,e=this.props,n=e.classes,i=e.currentUser,r="".concat(o(i,["attributes","first_name"])," ").concat(o(i,["attributes","last_name"]));return p("div",{style:this.props.spaceAround?z.commentTextFieldContainerSpaceAround:z.commentTextFieldContainer,children:[d("div",{style:z.chatAvatarWrapper,children:d(M,{displayName:r,imgSrc:this.props.currentUser&&this.props.currentUser.profile_photo})}),d(u,{className:this.props.classes.paperRoot,children:d(h,{"data-testid":"".concat("commentInput","_input"),placeholder:"Add Comment...",FormHelperTextProps:{component:"div",margin:"dense"},InputProps:{inputComponent:R,inputProps:{onChange:function(e){return t.setState({comment:e})},singleLine:!0,value:this.state.comment||"",inputRef:this.props.inputRef,withLightTheme:!1,onMount:this.props.onMount,companyId:this.props.companyId,autoFocus:this.props.autoFocus,disabled:this.props.disabled},endAdornment:!this.props.isNative&&p(f,{position:"end",className:this.props.classes.iconsContainer,children:[!this.state.attachmentUrl&&d(C,{title:"Attach File",placement:"bottom",classes:{tooltip:n.iconTooltip},children:d("div",{className:E(D.cCommentInputIconContainer,D.cCommentInputIconUpload),children:d(L,{openPreviewDialogOnUpload:!1,disableRipple:!0,onFinish:this.handleFileUpload,onError:this.handleAttachmentLoadingError,fileUploadIconClassName:this.props.classes.additionalActionButton,htmlColor:a[400],inputId:"comment-attachment-".concat(this.props.editCommentId)})})}),d(C,{title:"Add Emoji",placement:"bottom",classes:{tooltip:n.iconTooltip},children:d("div",{className:D.cCommentInputIconContainer,children:d(j,{"data-testid":"".concat("commentInput","_emojiButton"),handleSelectEmoji:this.handleSelectEmoji,emojiIconClassName:this.props.classes.additionalActionButton,htmlColor:a[400],disableRipple:!0})})})]}),disableUnderline:!0,classes:{root:this.props.classes.inputRoot,input:this.props.classes.inputEl}},className:this.props.classes.input,onKeyDown:this.handleKeyDown})}),this.state.attachmentLoadingError&&d(w,{errorMessage:this.state.attachmentLoadingError,className:this.props.classes.fileUploadingError}),this.state.attachmentUrl&&d(T,{fileName:this.state.attachmentName,fileUrl:this.state.attachmentUrl,handleFileDelete:this.handleFileDelete,classes:this.props.classes}),p("div",{className:D.cCommentInputSendContainer,children:[d("div",{className:D.cCommentInputSendContainerCancel,children:this.isEditMode&&d(g,{variant:"caption",className:E(this.props.classes.inputMain,this.props.classes.cancelText,this.props.classes.highlightedLabel),component:"div",gutterBottom:!0,onClick:this.props.exitEditMode,children:"Cancel"})}),p("div",{className:D.cCommentInputSendContainerSend,children:[p(g,{variant:"caption",className:E(this.props.classes.inputMain,this.props.classes.inputHelper),component:"div",gutterBottom:!0,children:["Press ",d(g,{variant:"caption",color:"primary",className:E(this.props.classes.inputMain,this.props.classes.highlightedLabel),children:"Enter"})," to send"]}),d(b,{"data-not-migrated-MuiIconButton":!0,"data-testid":"".concat("commentInput","_sendButton"),onClick:this.handleSendComment,children:d(P,{})})]})]})]})}},{key:"isEditMode",get:function(){return!!this.props.editFeedItemId}}]),y}();_.propTypes={inputRef:y.shape({}),editFeedItemId:y.number,editCommentId:y.number,editComment:y.string,editAttachment:y.shape({}),spaceAround:y.bool,postComment:y.func.isRequired,postCommentCallback:y.func,patchCommentCallback:y.func,exitEditMode:y.func,setIsPosting:y.func,setIsEditting:y.func,onMount:y.func,autoFocus:y.bool,disabled:y.bool,classes:y.shape({}).isRequired,currentUser:y.shape(),isNative:y.bool,companyId:y.number},_.defaultProps={inputRef:null,editFeedItemId:null,editCommentId:null,editComment:null,editAttachment:{},spaceAround:!1,setIsPosting:x,setIsEditting:x,onMount:x,autoFocus:void 0,disabled:!1,patchCommentCallback:x,postCommentCallback:x,exitEditMode:x,companyId:null,currentUser:{},isNative:m};var H=N((function(t){return{paperRoot:{width:"calc(100% - 28px)",marginLeft:25,display:"inline-block",height:35,border:"0","&:focus-within":{boxShadow:"inset 0 0 0 2px ".concat(t.palette.primary.main)},boxShadow:"none"},input:{paddingLeft:5,width:"100%"},inputRoot:{height:35,paddingRight:"10px",lineHeight:"29px",paddingLeft:"10px"},inputEl:{padding:"0 0 0 6px",height:"100%"},additionalActionButton:{padding:"5px","&:hover":{backgroundColor:"transparent"}},nativeActionButton:{margin:"5px 10px",cursor:"pointer"},fileUploadingError:{marginTop:10,marginLeft:24},inputMain:{marginBottom:0,fontSize:".7rem",color:t.palette.grey[700]},inputHelper:{display:"flex",paddingRight:5},cancelText:{cursor:"pointer"},highlightedLabel:{color:t.palette.primary.main},iconsContainer:{marginRight:"8px"},iconTooltip:{marginTop:"3px"}}}))(_);export default H;

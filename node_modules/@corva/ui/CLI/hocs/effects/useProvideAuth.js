import{get as r}from"lodash";import{updateUserUnits as t}from"../../../utils/convert.js";import e from"@babel/runtime/helpers/slicedToArray";import n from"@babel/runtime/regenerator";import o from"@babel/runtime/helpers/asyncToGenerator";import{useState as s,useEffect as i}from"react";import{setAuthToken as a,removeAuthToken as c,getAuthToken as u}from"../../../clients/clientStorage/index.js";import{post as p}from"../../../clients/api/apiCore.js";import"../../../clients/constants.js";import{getCurrentUser as l}from"../../../clients/jsonApi/index.js";import"../../../clients/subscriptions.js";import{useHistory as m,useLocation as f}from"react-router-dom";import{LOGIN_ROUTE_REG_EXP as h}from"../../constants/index.js";function v(){var v=s(null),d=e(v,2),b=d[0],x=d[1],y=s(!0),g=e(y,2),j=g[0],w=g[1],k=s(null),_=e(k,2),A=_[0],T=_[1],U=m(),W=f();function C(){return G.apply(this,arguments)}function G(){return(G=o(n.mark((function e(){var o;return n.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,w(!0),e.next=4,l();case 4:o=e.sent,x(o),t({userUnits:o.unit_system,companyUnits:r(o,"company.unit_system")}),e.next=14;break;case 9:e.prev=9,e.t0=e.catch(0),c(),U.push("login"),console.error(e.t0);case 14:w(!1);case 15:case"end":return e.stop()}}),e,null,[[0,9]])})))).apply(this,arguments)}var P,S=(P=o(n.mark((function r(t,e,o){var s;return n.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return r.prev=0,T(null),w(!0),r.next=5,p("/v1/user_token",{auth:{email:t,password:e}});case 5:s=r.sent,a(s.jwt),r.next=14;break;case 9:return r.prev=9,r.t0=r.catch(0),console.error(r.t0),w(!1),r.abrupt("return",T("Wrong user name or password"));case 14:C().then(o);case 15:case"end":return r.stop()}}),r,null,[[0,9]])}))),function(r,t,e){return P.apply(this,arguments)});return i((function(){var r;try{r=u()}catch(r){c()}var t=h.test(W.pathname);return!r&&t?w(!1):r?void C():(U.push("login"),w(!1))}),[]),{user:b,loading:j,error:A,loginWithPassword:S,logout:function(){c(),U.push("login")}}}export default v;

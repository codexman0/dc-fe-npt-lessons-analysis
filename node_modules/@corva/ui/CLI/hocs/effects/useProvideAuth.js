import"@babel/runtime/helpers/defineProperty";import{get as r}from"lodash";import{updateUserUnits as t}from"../../../utils/convert.js";import e from"@babel/runtime/helpers/slicedToArray";import n from"@babel/runtime/regenerator";import o from"@babel/runtime/helpers/asyncToGenerator";import{useState as s,useEffect as i}from"react";import{setAuthToken as a,removeAuthToken as u,getAuthToken as c}from"../../../clients/clientStorage/index.js";import{post as p}from"../../../clients/api/apiCore.js";import"../../../clients/constants.js";import{getCurrentUser as l}from"../../../clients/jsonApi/index.js";import"../../../clients/subscriptions.js";import"uuid";import{LOGIN_ROUTE_REG_EXP as m}from"../../constants/index.js";function f(f){var h=s(null),d=e(h,2),v=d[0],b=d[1],y=s(!0),x=e(y,2),g=x[0],j=x[1],w=s(null),k=e(w,2),_=k[0],A=k[1];function P(){return T.apply(this,arguments)}function T(){return(T=o(n.mark((function e(){var o;return n.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,j(!0),e.next=4,l();case 4:o=e.sent,b(o),t({userUnits:o.unit_system,companyUnits:r(o,"company.unit_system")}),e.next=14;break;case 9:e.prev=9,e.t0=e.catch(0),u(),f.push("login"),console.error(e.t0);case 14:j(!1);case 15:case"end":return e.stop()}}),e,null,[[0,9]])})))).apply(this,arguments)}var U,W=(U=o(n.mark((function r(t,e,o){var s;return n.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return r.prev=0,A(null),j(!0),r.next=5,p("/v1/user_token",{auth:{email:t,password:e}});case 5:s=r.sent,a(s.jwt),r.next=14;break;case 9:return r.prev=9,r.t0=r.catch(0),console.error(r.t0),j(!1),r.abrupt("return",A("Wrong user name or password"));case 14:P().then(o);case 15:case"end":return r.stop()}}),r,null,[[0,9]])}))),function(r,t,e){return U.apply(this,arguments)});return i((function(){var r;try{r=c()}catch(r){u()}var t=m.test(f.location.pathname);return!r&&t?j(!1):r?void P():(f.push("login"),j(!1))}),[]),{user:v,loading:g,error:_,loginWithPassword:W,logout:function(){u(),f.push("login")}}}export default f;
